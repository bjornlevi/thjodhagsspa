{% extends "layout.html" %}
{% block content %}

<h1>Útgáfuár (hlutfallsár): {{ choices|selectattr('0','equalto',label_key)|map(attribute=1)|list|first }}</h1>
{% include "_picker.html" %}


<canvas id="chart" height="120"></canvas>
<div id="abs-legend" class="mt-2"></div>
<div id="rel-table"></div>

<script>
const datasets = {{ datasets|tojson }};
const xmin = {{ x_min if x_min is not none else 0 }};
const xmax = {{ x_max if x_max is not none else 0 }};

const ctx = document.getElementById('chart').getContext('2d');
new Chart(ctx, {
  type: 'line',
  data: { datasets: datasets.map(ds => ({
    ...ds,
    parsing: false,
    segment: {
      borderDash: ctx => (ctx.p0?.raw?.type === 'extrapolation' || ctx.p1?.raw?.type === 'extrapolation') ? [6,4] : []
    },
    pointStyle: ctx => {
      const t = ctx.raw?.type;
      return t === 'forecast' ? 'triangle' : (t === 'extrapolation' ? 'rect' : 'circle');
    },
    radius: 3
  })) },
  options: {
    responsive: true,
    scales: {
      x: {
        type: 'linear',
        min: xmin - 0.5,
        max: xmax + 0.5,
        ticks: { callback: v => Math.round(v) },
        title: { display: true, text: "Ár frá spá (t=0 er spáár)" }
      },
      y: { title: { display: true, text: "Gildi" } }
    },
    plugins: {
      tooltip: {
        callbacks: {
          title: items => {
            const r = items[0].raw;
            const t = (r?.t_rel ?? 0);
            return `t = ${t >= 0 ? '+'+t : t}  (ár: ${r?.abs_year ?? ''})`;
          },
          label: item => `${item.dataset.label}: ${item.raw.y}`
        }
      },
      legend: { position: 'top' }
    }
  }
});
</script>
<script>
  // Table: relative years (t)
  renderTypeLegend('abs-legend');
  renderDatasetsTable(
    'rel-table',
    datasets,
    {
      xLabel: 't frá spá (ár)',
      xFmt: v => Math.round(v),
      valueFmt: v => (v == null ? '' : String(v))
    }
  );
</script>

{% endblock %}
